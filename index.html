<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å (Optimized)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
            background: #f8fafc;
            margin: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed;
            inset: 0;
            z-index: -1;
        }

        .container {
            background: rgba(255, 255, 255, 0.9);
            padding: 35px 40px;
            width: 95%;
            max-width: 850px;
        }

        h1 {
            text-align: center;
            font-weight: 600;
            margin-bottom: 25px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            border-radius: 10px;
            background: #e8edf3;
            cursor: pointer;
            transition: .25s;
        }

        .tab.active {
            background: #007bff;
            color: #fff;
            box-shadow: 0 4px 10px rgba(0, 123, 255, .3);
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        input,
        button {
            width: 100%;
            max-width: 500px;
            margin: 8px auto;
            padding: 10px 14px;
            border-radius: 8px;
            border: 1px solid #ccd6e0;
            font-size: 15px;
        }

        button {
            background: #007bff;
            color: #fff;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #0056b3;
        }

        button:active {
            transform: scale(.97);
        }

        #saveExcelBtn {
            width: 300px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 15px;
        }

        th,
        td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #e5e9ef;
        }

        th {
            background: #007bff;
            color: #fff;
        }

        tr:nth-child(even) {
            background: #f9fbff;
        }

        tr:hover td {
            background: #eef5ff;
        }

        #paginationControls,
        #editPaginationControls {
            display: flex !important;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        #paginationControls button,
        #editPaginationControls button {
            width: auto !important;
            /* prevent stretching */
            min-width: 350px;
            /* small but readable */
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #ffffff;
            color: #333;
            font-size: 14px;
            font-family: 'Segoe UI', sans-serif;
            cursor: pointer;
            /*transition: background-color 0.2s ease, color 0.2s ease;*/
        }

        #paginationControls button:disabled,
        #editPaginationControls button:disabled {
            background-color: #f3f3f3;
            color: #999;
            cursor: not-allowed;
        }

        #paginationControls button:not(:disabled):hover,
        #editPaginationControls button:not(:disabled):hover {
            background-color: #007bff;
            color: #fff;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f6f9ff;
            border: 1px solid #e3e9f2;
            border-radius: 12px;
            padding: 18px;
            text-align: center;
        }

        /* --- Modal Animation --- */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            backdrop-filter: blur(6px);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: #fff;
            padding: 20px 30px;
            border-radius: 16px;
            width: 100%;
            max-width: 420px;
            text-align: center;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.25s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        #addModal .modal-content input,
        #editModal .modal-content input {
            display: block;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            margin: 8px 0;
            padding: 12px 16px;
            border: 1px solid #ccd6e0;
            border-radius: 10px;
            font-size: 16px;
            text-align: center;
        }

        #addModal .modal-content button,
        #editModal .modal-content button {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            font-size: 16px;
            margin-top: 8px;
            cursor: pointer;
            transition: 0.2s;
        }

        #addModal #saveAddBtn,
        #editModal #saveEditBtn {
            background-color: #007bff;
            color: white;
            border: none;
        }

        #addModal #saveAddBtn:hover,
        #editModal #saveEditBtn:hover {
            background-color: #0056b3;
        }

        #addModal #cancelAddBtn,
        #editModal #cancelEditBtn {
            background-color: #e0e0e0;
            color: #333;
            border: none;
        }

        #addModal #cancelAddBtn:hover,
        #editModal #cancelEditBtn:hover {
            background-color: #c7c7c7;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üè• ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</h1>

        <div class="tabs">
            <div class="tab active" data-tab="upload">üìÇ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î / ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</div>
            <div class="tab" data-tab="add">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç / ‡∏•‡∏ö</div>
            <div class="tab" data-tab="stats">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>
        </div>

        <div id="upload" class="section active">
            <div class="button-group">
                <input type="file" id="fileInput" accept=".xlsx,.xls">
                <button id="saveExcelBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô Excel (.xlsx)</button>
            </div>
            <input style="display: flex; gap: 10px; align-items: center;" type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢...">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th>
                        <th>‡∏≠‡∏≤‡∏¢‡∏∏</th>
                        <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                        <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div id="paginationControls"></div>
        </div>

        <div id="add" class="section">
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <input type="text" id="editSearchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ..." style="flex: 1;">
                <button id="openAddModalBtn" style="width:400px; padding:10px 20px;">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</button>
            </div>

            <table id="editTable">
                <thead>
                    <tr>
                        <th>‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th>
                        <th>‡∏≠‡∏≤‡∏¢‡∏∏</th>
                        <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                        <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <div id="editPaginationControls"></div>
        </div>

        <div id="addModal" class="modal">
            <div class="modal-content">
                <h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡πÉ‡∏´‡∏°‡πà</h3>
                <input type="text" id="addId" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ß‡πâ‡∏ô‡πÑ‡∏ß‡πâ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)">
                <input type="text" id="addName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•">
                <input type="number" id="addAge" placeholder="‡∏≠‡∏≤‡∏¢‡∏∏">
                <input type="text" id="addPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
                <button id="saveAddBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                <button id="cancelAddBtn">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>


        <div id="stats" class="section">
            <h3 style="text-align:center;">üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ</h3>
            <div class="stats-grid">
                <div class="stat-card" id="totalPatients">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0</div>
                <div class="stat-card" id="averageAge">‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: -</div>
                <div class="stat-card" id="oldest">‡∏≠‡∏≤‡∏¢‡∏∏‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: -</div>
                <div class="stat-card" id="youngest">‡∏≠‡∏≤‡∏¢‡∏∏‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: -</div>
                <div class="stat-card" id="missingPhone">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: 0 ‡∏Ñ‡∏ô</div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h3>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ</h3>
            <input type="text" id="editId" readonly>
            <input type="text" id="editName" placeholder="‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•">
            <input type="number" id="editAge" placeholder="‡∏≠‡∏≤‡∏¢‡∏∏">
            <input type="text" id="editPhone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
            <button id="saveEditBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button id="cancelEditBtn">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <script>
        let patientData = [];
        let currentPage = 1;
        let currentEditPage = 1;
        const rowsPerPage = 100;

        document.querySelectorAll(".tab").forEach(tab => {
            tab.addEventListener("click", () => {
                document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
                document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
                tab.classList.add("active");
                document.getElementById(tab.dataset.tab).classList.add("active");
                if (tab.dataset.tab === "stats") updateStats();
                if (tab.dataset.tab === "add") renderEditTable();
            });
        });

        document.getElementById("fileInput").addEventListener("change", e => {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = evt => {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const sheet = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheet];
                patientData = XLSX.utils.sheet_to_json(worksheet);
                currentPage = 1; currentEditPage = 1;
                renderTable(patientData);
                renderEditTable();
                updateStats();
            };
            reader.readAsArrayBuffer(file);
        });

        const addModal = document.getElementById("addModal");
        document.getElementById("openAddModalBtn").addEventListener("click", () => {
            addModal.classList.add("show");
            ['addId', 'addName', 'addAge', 'addPhone'].forEach(id => document.getElementById(id).value = "");
        });

        document.getElementById("cancelAddBtn").addEventListener("click", () => {
            addModal.classList.remove("show");
        });

        document.getElementById("saveAddBtn").addEventListener("click", () => {
            const id = document.getElementById("addId").value.trim() || generatePatientID();
            const name = document.getElementById("addName").value.trim();
            const age = document.getElementById("addAge").value.trim();
            const phone = document.getElementById("addPhone").value.trim();
            if (!name) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•"); return; }

            const exists = patientData.some(p => String(p["‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢"]) === id);
            if (exists) {
                alert("‚ö†Ô∏è ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß!");
                return;
            }

            patientData.push({
                "‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢": id,
                "‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•": name,
                "‡∏≠‡∏≤‡∏¢‡∏∏": age || "‚Äî",
                "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå": phone || "‚Äî"
            });

            alert("‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            modal.classList.remove("show");
            renderTable(patientData);
            renderEditTable();
            updateStats();
        });
        function generatePatientID() { return Math.floor(10000 + Math.random() * 90000); }

        document.getElementById("editSearchInput").addEventListener("input", debounce(e => {
            const q = e.target.value.toLowerCase();
            const filtered = patientData.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(q)));
            currentEditPage = 1;
            renderFilteredEditTable(filtered);
        }));

        function renderTable(data) {
            const head = document.querySelector("#dataTable thead");
            const body = document.querySelector("#dataTable tbody");
            head.innerHTML = ""; body.innerHTML = "";

            if (!data.length) {
                body.innerHTML = "<tr><td colspan='4'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ</td></tr>";
                document.getElementById("paginationControls").innerHTML = "";
                return;
            }
            const headers = ["‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢", "‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•", "‡∏≠‡∏≤‡∏¢‡∏∏", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"];
            const headerRow = document.createElement("tr");
            headers.forEach(h => { const th = document.createElement("th"); th.textContent = h; headerRow.appendChild(th); });
            head.appendChild(headerRow);

            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = data.slice(start, end);

            const fragment = document.createDocumentFragment();
            pageData.forEach(row => {
                const tr = document.createElement("tr");
                headers.forEach(h => {
                    const td = document.createElement("td");
                    td.textContent = row[h] || "‚Äî";
                    tr.appendChild(td);
                });
                fragment.appendChild(tr);
            });
            body.appendChild(fragment);
            renderPaginationControls(data.length);
        }

        function renderPaginationControls(totalRows) {
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            const container = document.getElementById("paginationControls");
            container.innerHTML = "";

            if (totalPages <= 1) return;

            const prevBtn = createBtn("<", currentPage === 1, () => { if (currentPage > 1) { currentPage--; renderTable(patientData); } });
            const nextBtn = createBtn(">", currentPage === totalPages, () => { if (currentPage < totalPages) { currentPage++; renderTable(patientData); } });
            const pageLabel = createLabel(`‡∏´‡∏ô‡πâ‡∏≤ ${currentPage} ‡∏à‡∏≤‡∏Å ${totalPages}`);

            container.append(prevBtn, pageLabel, nextBtn);
        }

        function createBtn(label, disabled, onClick) {
            const btn = document.createElement("button");
            btn.textContent = label;
            btn.disabled = disabled;
            btn.onclick = onClick;
            return btn;
        }
        function createLabel(text) {
            const span = document.createElement("span");
            span.textContent = text;
            span.style.padding = "6px 14px";
            span.style.border = "1px solid #ddd";
            span.style.borderRadius = "6px";
            span.style.background = "#f9f9f9";
            span.style.minWidth = "120px";
            span.style.display = "inline-block";
            return span;
        }

        function debounce(fn, delay = 300) {
            let timer; return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), delay); };
        }
        document.getElementById("searchInput").addEventListener("input", debounce(e => {
            const q = e.target.value.toLowerCase();
            const filtered = patientData.filter(r => Object.values(r).some(v => String(v).toLowerCase().includes(q)));
            currentPage = 1;
            renderTable(filtered);
        }));

        function renderFilteredEditTable(data) {
            const tbody = document.querySelector("#editTable tbody");
            tbody.innerHTML = "";

            if (!data.length) {
                tbody.innerHTML = "<tr><td colspan='5'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</td></tr>";
                document.getElementById("editPaginationControls").innerHTML = "";
                return;
            }

            const start = (currentEditPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = data.slice(start, end);

            const frag = document.createDocumentFragment();
            pageData.forEach(p => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
      <td>${p["‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢"] || "‚Äî"}</td>
      <td>${p["‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•"] || "‚Äî"}</td>
      <td>${p["‡∏≠‡∏≤‡∏¢‡∏∏"] || "‚Äî"}</td>
      <td>${p["‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"] || "‚Äî"}</td>
      <td>
        <button onclick="editPatient('${p["‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢"]}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button onclick="deletePatient('${p["‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢"]}')">üóëÔ∏è ‡∏•‡∏ö</button>
      </td>`;
                frag.appendChild(tr);
            });
            tbody.appendChild(frag);
        }


        function renderEditTable() {
            const tbody = document.querySelector("#editTable tbody");
            tbody.innerHTML = "";

            if (!patientData.length) {
                tbody.innerHTML = "<tr><td colspan='5'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ</td></tr>";
                document.getElementById("editPaginationControls").innerHTML = "";
                return;
            }

            const start = (currentEditPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            const pageData = patientData.slice(start, end);

            const frag = document.createDocumentFragment();
            pageData.forEach(p => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
      <td>${p["‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢"] || "‚Äî"}</td>
      <td>${p["‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•"] || "‚Äî"}</td>
      <td>${p["‡∏≠‡∏≤‡∏¢‡∏∏"] || "‚Äî"}</td>
      <td>${p["‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"] || "‚Äî"}</td>
      <td>
        <button onclick="editPatient('${p["‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢"]}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button onclick="deletePatient('${p["‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢"]}')">üóëÔ∏è ‡∏•‡∏ö</button>
      </td>`;
                frag.appendChild(tr);
            });
            tbody.appendChild(frag);
            renderEditPaginationControls(patientData.length);
        }

        function renderEditPaginationControls(totalRows) {
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            const container = document.getElementById("editPaginationControls");
            container.innerHTML = "";
            if (totalPages <= 1) return;

            const prevBtn = createBtn("<", currentEditPage === 1, () => { if (currentEditPage > 1) { currentEditPage--; renderEditTable(); } });
            const nextBtn = createBtn(">", currentEditPage === totalPages, () => { if (currentEditPage < totalPages) { currentEditPage++; renderEditTable(); } });
            const pageLabel = createLabel(`‡∏´‡∏ô‡πâ‡∏≤ ${currentEditPage} ‡∏à‡∏≤‡∏Å ${totalPages}`);

            container.append(prevBtn, pageLabel, nextBtn);
        }

        function deletePatient(id) {
            patientData = patientData.filter(p => String(p["‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢"]) !== id);
            renderTable(patientData);
            renderEditTable();
            updateStats();
        }

        function editPatient(id) {
            const p = patientData.find(p => String(p["‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢"]) === id);
            if (!p) return;
            const modal = document.getElementById("editModal");
            modal.classList.add("show");
            document.getElementById("editId").value = p["‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢"];
            document.getElementById("editName").value = p["‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•"];
            document.getElementById("editAge").value = p["‡∏≠‡∏≤‡∏¢‡∏∏"] !== "‚Äî" ? p["‡∏≠‡∏≤‡∏¢‡∏∏"] : "";
            document.getElementById("editPhone").value = p["‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"] !== "‚Äî" ? p["‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"] : "";

            document.getElementById("saveEditBtn").onclick = () => {
                p["‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•"] = document.getElementById("editName").value.trim() || "‚Äî";
                p["‡∏≠‡∏≤‡∏¢‡∏∏"] = document.getElementById("editAge").value.trim() || "‚Äî";
                p["‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"] = document.getElementById("editPhone").value.trim() || "‚Äî";
                modal.classList.remove("show");
                renderTable(patientData);
                renderEditTable();
                updateStats();
            };
            document.getElementById("cancelEditBtn").onclick = () => modal.classList.remove("show");
        }
        window.onclick = e => {
            const modal = document.getElementById("editModal");
            const modal2 = document.getElementById("addModal");
            if (e.target === modal) modal.classList.remove("show");;
            if (e.target === modal2) modal2.classList.remove("show");;
        };

        document.getElementById("saveExcelBtn").addEventListener("click", () => {
            if (!patientData.length) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"); return; }
            const ws = XLSX.utils.json_to_sheet(patientData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ");
            const now = new Date();
            const name = `‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ_${now.getFullYear()}${now.getMonth() + 1}${now.getDate()}.xlsx`;
            XLSX.writeFile(wb, name);
        });

        function updateStats() {
            const total = patientData.length;
            const ages = patientData.map(p => parseInt(p["‡∏≠‡∏≤‡∏¢‡∏∏"])).filter(n => !isNaN(n));
            const avg = ages.length ? (ages.reduce((a, b) => a + b) / ages.length).toFixed(1) : "‚Äî";
            const max = ages.length ? Math.max(...ages) : "‚Äî";
            const min = ages.length ? Math.min(...ages) : "‚Äî";
            const noPhone = patientData.filter(p => !p["‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"] || p["‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå"] === "‚Äî").length;
            document.getElementById("totalPatients").textContent = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total}`;
            document.getElementById("averageAge").textContent = `‡∏≠‡∏≤‡∏¢‡∏∏‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢: ${avg}`;
            document.getElementById("oldest").textContent = `‡∏≠‡∏≤‡∏¢‡∏∏‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: ${max}`;
            document.getElementById("youngest").textContent = `‡∏≠‡∏≤‡∏¢‡∏∏‡∏ô‡πâ‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î: ${min}`;
            document.getElementById("missingPhone").textContent = `‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£: ${noPhone} ‡∏Ñ‡∏ô`;
        }
    </script>
</body>

</html>